<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Consulta de Lote</title>

  <!-- Bootstrap e Leaflet CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder/dist/esri-leaflet-geocoder.css" />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #map {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
    }

    #sidebar-esquerda {
      position: fixed;
      top: 0;
      left: 0;
      width: 500px;
      height: 100%;
      background-color: rgba(250, 250, 250, 0.85);
      padding: 1rem;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
    }

    #sidebar-direita {
      position: fixed;
      top: 0;
      right: 0;
      width: 400px;
      height: 100%;
      background-color: rgba(250, 250, 250, 0.85);
      padding: 1rem;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.2);
    }

    .topmenu h2 {
      font-size: 1.4rem;
      margin-bottom: 1rem;
      color: black;
    }

    .leaflet-control-layers {
      margin-top: 60px;
    }
  </style>
</head>

<body>
  <!-- Mapa em segundo plano -->
  <div id="map"></div>

  <!-- Sidebar esquerda (busca e cálculo) -->
  <div id="sidebar-esquerda">
    <div class="topmenu">
      <h2>Consulta de Lote</h2>
    </div>

    <form method="POST" class="mb-3">
      <div class="input-group mb-2">
        <input type="text" name="indicacao_fiscal" class="form-control" placeholder="Indicação Fiscal" required />
        <button type="submit" class="btn btn-primary">Buscar</button>
      </div>
    </form>

    {% if mensagem %}
      <div class="alert alert-warning mt-3">{{ mensagem }}</div>
    {% endif %}

    {% if html_calc %}
      <h4>Cálculo de Potencial Construtivo</h4>
      {{ html_calc | safe }}
    {% endif %}
  </div>

  <!-- Sidebar direita (dados extras) -->
  <div id="sidebar-direita">
    {% if html_lote %}
      <h4>Dados do Lote</h4>
      {{ html_lote | safe }}
    {% endif %}

    {% if html_extra %}
      <h4>Outros Dados</h4>
      {{ html_extra | safe }}
    {% endif %}
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>

  <script>
    const indicacaoFiscal = "{{ request.form.get('indicacao_fiscal', '') }}";
    const lat = {{ lat if lat else 'null' }};
    const lon = {{ lon if lon else 'null' }};

    const map = L.map("map", {
      center: lat && lon ? [lat, lon] : [-25.4284, -49.2733],
      zoom: lat && lon ? 18 : 16,
      minZoom: 10,
      maxZoom: 23,
      zoomControl: false,
      attributionControl: true
    });

    const ortofoto2019 = L.esri.tiledMapLayer({
      url: "https://geocuritiba.ippuc.org.br/server/rest/services/Hosted/Ortofotos2019/MapServer",
      maxZoom: 23,
      attribution: "Ortofotos © GeoCuritiba"
    });

    const mapaCadastral = L.esri.dynamicMapLayer({
      url: "https://geocuritiba.ippuc.org.br/server/rest/services/GeoCuritiba/Publico_GeoCuritiba_MapaCadastral/MapServer",
      layers: [23],
      opacity: 0.8
    });

    const lotecadastral = L.esri.dynamicMapLayer({
      url: "https://geocuritiba.ippuc.org.br/server/rest/services/GeoCuritiba/Publico_GeoCuritiba_MapaCadastral/MapServer",
      layers: [15],
      opacity: 0.8
    });

    const sviario = L.esri.dynamicMapLayer({
      url: "https://geocuritiba.ippuc.org.br/server/rest/services/GeoCuritiba/Publico_GeoCuritiba_MapaCadastral/MapServer",
      layers: [34],
      opacity: 0.8
    });

    ortofoto2019.addTo(map);
    mapaCadastral.addTo(map);
    lotecadastral.addTo(map);
    sviario.addTo(map);

    if (indicacaoFiscal) {
      const textos = L.esri.featureLayer({
        url: "https://geocuritiba.ippuc.org.br/server/rest/services/GeoCuritiba/Publico_GeoCuritiba_MapaCadastral/MapServer/16",
        where: `gtm_ind_fiscal = '${indicacaoFiscal}'`,
        style: {
          color: 'red',
          weight: 2,
          fillOpacity: 0.2
        },
        onEachFeature: function (feature, layer) {
          const props = feature.properties;
          layer.bindPopup(`<b>Indicação Fiscal:</b> ${props.gtm_ind_fiscal}`);
        }
      }).addTo(map);

      let jaZoonou = false;

      textos.on('load', function () {
        if (!jaZoonou) {
          textos.query().where(`gtm_ind_fiscal = '${indicacaoFiscal}'`).bounds(function (error, bounds) {
            if (!error && bounds) {
              jaZoonou = true;
              map.fitBounds(bounds, { maxZoom: 19 });
            }
          });
        }
      });
    } else {
      const textos = L.esri.dynamicMapLayer({
        url: "https://geocuritiba.ippuc.org.br/server/rest/services/GeoCuritiba/Publico_GeoCuritiba_MapaCadastral/MapServer",
        layers: [16],
        opacity: 0.8
      }).addTo(map);
    }

    const baseLayers = {
      "Ortofotos 2019": ortofoto2019
    };

    const overlayLayers = {
      "Mapa Cadastral (23)": mapaCadastral,
      "Lotes (15)": lotecadastral,
      "Sistema Viário (34)": sviario
    };

    L.control.layers(baseLayers, overlayLayers, { position: 'topright' }).addTo(map);

    if (lat && lon) {
      L.marker([lat, lon]).addTo(map)
        .bindPopup("Lote centralizado")
        .openPopup();
    }
  </script>
</body>
</html>
